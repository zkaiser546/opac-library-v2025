<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USEP Library Borrowing System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Profile Picture */
        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 24px;
            color: #4a5568;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Custom Colors */
        .bg-usepgold { background-color: #FFD700; }
        .bg-usepmaroon { background-color: #800000; }
        .text-usepmaroon { color: #800000; }
        .focus\:ring-usepmaroon:focus { --tw-ring-color: #800000; }

        /* Body Background with Overlay */
        body {
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: url('../landing_page/images/eagle.jpg');
            background-size: cover;
            background-position: center;
            z-index: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }

        body::before {
            content: "";
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: -1;
        }

        /* Main Layout */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 2rem 0;
        }

        #container-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .form-container {
            flex: 0 1 600px;
            min-height: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Form Box Styling */
        .form-box {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            padding: 2rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* Container Transitions */
        #first-container {
            opacity: 1;
            transition: all 0.3s ease;
        }

        #second-container {
            opacity: 0;
            transform: translateX(20px);
            visibility: hidden;
            transition: all 0.3s ease;
            position: absolute;
        }

        #second-container.show {
            opacity: 1;
            transform: translateX(0);
            visibility: visible;
            position: relative;
        }

        #second-container_returning {
            opacity: 0;
            transform: translateX(20px);
            visibility: hidden;
            transition: all 0.3s ease;
            position: absolute;
        }

        #second-container_returning.show {
            opacity: 1;
            transform: translateX(0);
            visibility: visible;
            position: relative;
        }

        /* Mobile Adjustments */
        @media (max-width: 1024px) {
            #container-wrapper {
                flex-direction: column;
                gap: 1.5rem;
            }

            .form-container {
                width: 100%;
                max-width: 600px;
                min-height: auto;
            }

            #second-container, #second-container_returning {
                position: relative;
                transform: translateY(20px);
            }

            #second-container.show, #second-container_returning.show {
                transform: translateY(0);
            }
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 100;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            padding: 1.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Improved Dropdown Styling */
        .dropdown {
            position: relative;
            margin-bottom: 1rem;
        }

        .dropdown-btn {
            width: 100%;
            text-align: left;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            width: 100%;
            background-color: white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 0.25rem;
            border: 1px solid #e5e7eb;
        }

        .dropdown-option {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background-color: #f9fafb;
        }

        .dropdown-option i {
            margin-right: 0.5rem;
            color: #800000;
        }

        .dropdown.show .dropdown-content {
            display: block;
        }

        .selected-option {
            font-weight: 500;
            color: #800000;
        }

        /* Hidden scanner input */
        .scanner-input {
            position: absolute;
            opacity: 0;
            height: 0;
            width: 0;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
<!-- Hidden input for scanner -->
<input type="text" id="scanner-input" class="scanner-input" autocomplete="off">

<!-- Main Content Area -->
<div id="main-content">
    <!-- Container Wrapper -->
    <div id="container-wrapper">
        <!-- First Container (Search Form) -->
        <div id="first-container" class="form-container">
            <div class="form-box">
                <div class="text-center mb-8">
                    <img src="../landing_page/images/usep-logo-small.png" alt="USEP Logo" class="h-20 mx-auto mb-2">
                    <h1 class="text-2xl font-bold text-usepmaroon">USEP Library Borrowing System</h1>
                    <p class="text-gray-600 mt-1">Tagum-Mabini Campus</p>
                </div>

                <div class="space-y-4 flex-grow">
                    <button id="scan-qr-btn" class="w-full flex items-center justify-center bg-usepmaroon hover:bg-usepmaroon/90 text-white py-3 px-6 rounded-lg text-lg transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-qrcode mr-3"></i>
                        Scan Book QR Code
                    </button>

                    <div class="relative flex items-center my-4">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-500">OR</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Enter Accession Number:</label>
                            <input type="text" id="accession-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-usepmaroon focus:border-usepmaroon" placeholder="e.g. ACC-001 or ACC001">
                        </div>

                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 mb-1">OR Search by Title/Author:</label>
                            <input type="text" id="book-search" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-usepmaroon focus:border-usepmaroon" placeholder="Search books...">
                            <div id="search-results" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                        </div>

                        <button id="find-book-btn" class="w-full bg-usepgold hover:bg-usepgold/90 text-usepmaroon py-3 px-6 rounded-lg font-medium transition-all shadow-md hover:shadow-lg mt-4">
                            Find Book
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Container (Book Details for Returning) -->
        <div id="second-container_returning" class="form-container">
            <div class="form-box">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-usepmaroon">Book Details</h2>
                    <button id="close-return-details" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="return-book-details-content" class="flex-grow">
                    <!-- Content will be inserted here -->
                </div>

                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <p class="text-sm text-gray-600">Return date: <span id="return-date" class="font-medium"></span></p>
                </div>

                <button id="return-btn" class="w-full bg-usepmaroon hover:bg-usepmaroon/90 text-white py-3 px-6 rounded-lg font-medium transition-all shadow-md hover:shadow-lg">
                    Return Book
                </button>
            </div>
        </div>

        <!-- Second Container (Book Details for Borrowing) -->
        <div id="second-container" class="form-container">
            <div class="form-box">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-usepmaroon">Book Details</h2>
                    <button id="close-book-details" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="book-details-content" class="flex-grow">
                    <!-- Content will be inserted here -->
                </div>

                <div class="mt-2 mb-4">
                    <h3 class="font-semibold text-usepmaroon mb-3 text-lg">Borrowing Options</h3>
                </div>

                <!-- Improved Dropdown -->
                <div class="dropdown" id="borrow-type-dropdown">
                    <button class="dropdown-btn" id="dropdown-btn">
                        <span id="selected-option-text">Select borrowing type</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-content">
                        <div class="dropdown-option" data-type="inside">
                            <i class="fas fa-book-reader"></i>
                            <span>Borrow for use inside the library</span>
                        </div>
                        <div class="dropdown-option" data-type="outside">
                            <i class="fas fa-book"></i>
                            <span>Borrow to take outside the library</span>
                        </div>
                    </div>
                </div>

                <div id="outside-borrow-warning" class="text-left bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded-lg mb-4 hidden">
                    <p class="text-sm text-yellow-800 font-semibold flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Please make sure to return the book on or before the due date to avoid penalties. Thank you!
                    </p>
                </div>

                <div id="due-date-container" class="bg-gray-50 p-4 rounded-lg mb-6 hidden">
                    <p class="text-sm text-gray-600">Due date: <span id="due-date" class="font-medium"></span></p>
                </div>

                <button id="borrow-btn" class="w-full bg-usepmaroon hover:bg-usepmaroon/90 text-white py-3 px-6 rounded-lg font-medium transition-all shadow-md hover:shadow-lg">
                    Borrow Book
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Student ID Modal -->
<div id="student-id-modal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-usepmaroon">Enter Student ID</h3>
            <button id="close-student-modal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="bg-yellow-100 border-l-4 border-yellow-500 p-3 rounded-lg mb-4">
            <p class="text-yellow-900 font-semibold text-base leading-relaxed">
                You can scan your ID card (RFID/barcode) or enter your Student ID manually.
            </p>
        </div>

        <div class="mb-4">
            <input type="text" id="student-id" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-usepmaroon focus:border-usepmaroon" placeholder="e.g. 2023-12345 or 202312345">
        </div>

        <div id="student-info" class="hidden bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex flex-col items-center text-center">
                <div class="profile-pic mb-3" id="student-pic"></div>
                <h4 class="font-medium text-gray-800" id="student-name"></h4>
                <p class="text-sm text-gray-600" id="student-course"></p>
                <p class="text-xs text-gray-500" id="student-id-display"></p>
            </div>
        </div>

        <button id="confirm-borrow" class="w-full bg-usepmaroon hover:bg-usepmaroon/90 text-white py-2 px-4 rounded-lg font-medium transition-all">
            Confirm Borrow
        </button>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="qr-scanner-modal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-usepmaroon">Scan Book QR Code</h2>
            <button id="close-qr-scanner" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="border-2 border-gray-300 rounded-lg overflow-hidden mb-4">
            <video id="qr-video" width="100%" height="auto" playsinline></video>
        </div>

        <p class="text-sm text-gray-500 text-center">Point your camera at the book's QR code</p>
    </div>
</div>

<script>
    // ================== GLOBAL VARIABLES ================== //
    let currentBook = null;
    let currentBorrower = null;
    let qrStream = null;
    let borrowType = 'inside';
    let scannerBuffer = '';
    let scannerTimeout;
    const SCANNER_DELAY = 100;

    // ================== DOM ELEMENTS ================== //
    const containerWrapper = document.getElementById('container-wrapper');
    const firstContainer = document.getElementById('first-container');
    const secondContainer = document.getElementById('second-container');
    const secondContainerReturning = document.getElementById('second-container_returning');
    const bookDetailsContent = document.getElementById('book-details-content');
    const returnBookDetailsContent = document.getElementById('return-book-details-content');
    const scanQrBtn = document.getElementById('scan-qr-btn');
    const findBookBtn = document.getElementById('find-book-btn');
    const closeBookDetails = document.getElementById('close-book-details');
    const closeReturnDetails = document.getElementById('close-return-details');
    const borrowBtn = document.getElementById('borrow-btn');
    const returnBtn = document.getElementById('return-btn');
    const accessionInput = document.getElementById('accession-input');
    const bookSearch = document.getElementById('book-search');
    const studentId = document.getElementById('student-id');
    const searchResults = document.getElementById('search-results');
    const studentIdModal = document.getElementById('student-id-modal');
    const qrScannerModal = document.getElementById('qr-scanner-modal');
    const closeStudentModal = document.getElementById('close-student-modal');
    const closeQrScanner = document.getElementById('close-qr-scanner');
    const confirmBorrow = document.getElementById('confirm-borrow');
    const qrVideo = document.getElementById('qr-video');
    const studentInfo = document.getElementById('student-info');
    const studentPic = document.getElementById('student-pic');
    const studentName = document.getElementById('student-name');
    const studentCourse = document.getElementById('student-course');
    const studentIdDisplay = document.getElementById('student-id-display');
    const scannerInput = document.getElementById('scanner-input');
    const dropdown = document.getElementById('borrow-type-dropdown');
    const dropdownBtn = document.getElementById('dropdown-btn');
    const selectedOptionText = document.getElementById('selected-option-text');
    const returnDate = document.getElementById('return-date');
    const dueDateContainer = document.getElementById('due-date-container');
    const outsideBorrowWarning = document.getElementById('outside-borrow-warning');

    // ================== SAMPLE DATA ================== //
    const bookDatabase = [
        {accession: "ACC-001", title: "Introduction to Computer Science", author: "John Doe", available: true, image: "https://m.media-amazon.com/images/I/71tR3ZEQZBL._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC001", title: "Introduction to Computer Science", author: "John Doe", available: true, image: "https://m.media-amazon.com/images/I/71tR3ZEQZBL._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC-002", title: "Advanced Programming", author: "Jane Smith", available: true, image: "https://m.media-amazon.com/images/I/81s6DUyQCZL._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC002", title: "Advanced Programming", author: "Jane Smith", available: true, image: "https://m.media-amazon.com/images/I/81s6DUyQCZL._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC-003", title: "Database Systems", author: "Robert Johnson", available: false, image: "https://m.media-amazon.com/images/I/61yB0UFlM3L._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC003", title: "Database Systems", author: "Robert Johnson", available: false, image: "https://m.media-amazon.com/images/I/61yB0UFlM3L._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC-004", title: "Data Structures", author: "Emily Davis", available: true, image: "https://m.media-amazon.com/images/I/81vpsIs58WL._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC004", title: "Data Structures", author: "Emily Davis", available: true, image: "https://m.media-amazon.com/images/I/81vpsIs58WL._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC-005", title: "Algorithms", author: "Michael Brown", available: true, image: "https://m.media-amazon.com/images/I/71kwaIeQeFL._AC_UF1000,1000_QL80_.jpg"},
        {accession: "ACC005", title: "Algorithms", author: "Michael Brown", available: true, image: "https://m.media-amazon.com/images/I/71kwaIeQeFL._AC_UF1000,1000_QL80_.jpg"}
    ];

    const borrowerDatabase = [
        {id: "2023-12345", name: "Juan Dela Cruz", course: "BS Computer Science", initials: "JC"},
        {id: "202312345", name: "Juan Dela Cruz", course: "BS Computer Science", initials: "JC"},
        {id: "2023-54321", name: "Maria Santos", course: "BS Information Technology", initials: "MS"},
        {id: "202354321", name: "Maria Santos", course: "BS Information Technology", initials: "MS"},
        {id: "2023-67890", name: "Pedro Reyes", course: "BS Electrical Engineering", initials: "PR"},
        {id: "202367890", name: "Pedro Reyes", course: "BS Electrical Engineering", initials: "PR"},
        {id: "RFID12345678", name: "Ana Cruz", course: "Graduate School", initials: "AC"},
        {id: "BC987654321", name: "Carlos Lim", course: "Graduate School", initials: "CL"}
    ];

    // ================== INITIALIZATION ================== //
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        scannerInput.focus(); // Focus hidden scanner input on load
        // Set default borrow type
        document.querySelector('.dropdown-option[data-type="inside"]').click();
    });

    // ================== HELPER FUNCTIONS ================== //
    function normalizeId(id) {
        return id.replace(/-/g, '').toUpperCase();
    }

    function showModal(modal) {
        modal.classList.add('show');
    }

    function closeModal(modal) {
        modal.classList.remove('show');
    }

    function showBookDetailsContainer(book) {
        const today = new Date();
        const dueDateObj = new Date();
        dueDateObj.setDate(today.getDate() + (borrowType === 'inside' ? 7 : 14));

        bookDetailsContent.innerHTML = `
            <div class="flex mb-6">
                <img src="${book.image}" alt="${book.title}" class="w-24 h-32 object-cover rounded-lg mr-4">
                <div>
                    <h3 class="font-bold text-lg text-usepmaroon">${book.title}</h3>
                    <p class="text-gray-600">${book.author}</p>
                    <p class="text-sm text-gray-500 mt-2">Accession: ${book.accession}</p>
                    <p class="text-sm ${book.available ? 'text-green-600' : 'text-red-600'} font-medium mt-1">
                        ${book.available ? 'Available' : 'Checked Out'}
                    </p>
                </div>
            </div>
        `;

        document.getElementById('due-date').textContent = dueDateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Show appropriate container based on availability
        if (book.available) {
            secondContainer.classList.add('show');
            secondContainerReturning.classList.remove('show');
        } else {
            showReturnBookDetailsContainer(book);
        }

        if (window.innerWidth > 1024) {
            containerWrapper.style.maxWidth = '1400px';
        }
    }

    function showReturnBookDetailsContainer(book) {
        const today = new Date();

        returnBookDetailsContent.innerHTML = `
            <div class="flex mb-6">
                <img src="${book.image}" alt="${book.title}" class="w-24 h-32 object-cover rounded-lg mr-4">
                <div>
                    <h3 class="font-bold text-lg text-usepmaroon">${book.title}</h3>
                    <p class="text-gray-600">${book.author}</p>
                    <p class="text-sm text-gray-500 mt-2">Accession: ${book.accession}</p>
                    <p class="text-sm text-red-600 font-medium mt-1">
                        Currently Checked Out
                    </p>
                </div>
            </div>
        `;

        returnDate.textContent = today.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        secondContainerReturning.classList.add('show');
        secondContainer.classList.remove('show');

        if (window.innerWidth > 1024) {
            containerWrapper.style.maxWidth = '1400px';
        }
    }

    function closeBookDetailsContainer() {
        secondContainer.classList.remove('show');
        secondContainerReturning.classList.remove('show');
        containerWrapper.style.maxWidth = '';
    }

    function resetForms() {
        accessionInput.value = '';
        bookSearch.value = '';
        studentId.value = '';
        studentInfo.classList.add('hidden');
        currentBook = null;
        currentBorrower = null;
        borrowType = 'inside';
        // Reset to default borrow type
        document.querySelector('.dropdown-option[data-type="inside"]').click();
    }

    function updateDueDate() {
        const today = new Date();
        const dueDateObj = new Date();
        dueDateObj.setDate(today.getDate() + (borrowType === 'inside' ? 7 : 14));

        document.getElementById('due-date').textContent = dueDateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Show/hide warning and due date based on borrow type
        if (borrowType === 'inside') {
            outsideBorrowWarning.classList.add('hidden');
            dueDateContainer.classList.add('hidden');
        } else {
            outsideBorrowWarning.classList.remove('hidden');
            dueDateContainer.classList.remove('hidden');
        }
    }

    // ================== DROPDOWN FUNCTIONALITY ================== //
    function setupDropdown() {
        // Toggle dropdown visibility
        dropdownBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.classList.toggle('show');
        });

        // Handle option selection
        document.querySelectorAll('.dropdown-option').forEach(option => {
            option.addEventListener('click', function() {
                borrowType = this.getAttribute('data-type');
                const optionText = this.querySelector('span').textContent;

                // Update displayed text
                selectedOptionText.textContent = optionText;
                selectedOptionText.classList.add('selected-option');

                // Highlight selected option
                document.querySelectorAll('.dropdown-option').forEach(opt => {
                    opt.classList.remove('bg-gray-100');
                });
                this.classList.add('bg-gray-100');

                // Close dropdown
                dropdown.classList.remove('show');

                // Update due date
                updateDueDate();
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
    }

    // ================== SCANNER FUNCTIONS ================== //
    function handleScannedCode(code) {
        // Normalize the code by removing hyphens
        const normalizedCode = normalizeId(code);

        // Find book by either original accession or normalized version
        const book = bookDatabase.find(b =>
            b.accession === code || normalizeId(b.accession) === normalizedCode
        );

        if (book) {
            currentBook = book;

            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrVideo.srcObject = null;
                qrStream = null;
            }

            closeModal(qrScannerModal);
            showBookDetailsContainer(book);
            Swal.fire({
                icon: 'success',
                title: 'Book Found!',
                text: `${book.title} by ${book.author}`,
                confirmButtonColor: '#800000'
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Book Not Found',
                text: 'Please try another code.',
                confirmButtonColor: '#800000'
            });
            requestAnimationFrame(scanQR);
        }
    }

    function startQRScanner() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function (stream) {
                qrStream = stream;
                qrVideo.srcObject = stream;
                qrVideo.setAttribute("playsinline", true);
                qrVideo.play();
                requestAnimationFrame(scanQR);
            })
            .catch(function (err) {
                console.error("Error accessing camera: ", err);
                Swal.fire({
                    icon: 'error',
                    title: 'Camera Error',
                    text: 'Could not access camera. Please check permissions.',
                    confirmButtonColor: '#800000'
                });
            });
    }

    function scanQR() {
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
            const canvas = document.createElement('canvas');
            canvas.width = qrVideo.videoWidth;
            canvas.height = qrVideo.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);

            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                handleScannedCode(code.data);
            } else {
                requestAnimationFrame(scanQR);
            }
        } else {
            requestAnimationFrame(scanQR);
        }
    }

    // ================== RFID/BARCODE SCANNER HANDLING ================== //
    function setupScannerInput() {
        scannerInput.addEventListener('keydown', function(e) {
            // Clear any existing timeout
            clearTimeout(scannerTimeout);

            // Append the character to buffer
            if (e.key.length === 1) {
                scannerBuffer += e.key;
            }

            // Set a timeout to process the buffer if no more input comes
            scannerTimeout = setTimeout(() => {
                if (scannerBuffer.length > 0) {
                    processScannedId(scannerBuffer);
                    scannerBuffer = '';
                }
            }, SCANNER_DELAY);
        });
    }

    function processScannedId(id) {
        // If we're in student ID modal, treat as student ID
        if (studentIdModal.classList.contains('show')) {
            studentId.value = id;
            handleStudentIdInput.call(studentId);
            return;
        }

        // Otherwise treat as book accession number
        accessionInput.value = id;
        findBook();
    }

    // ================== EVENT HANDLERS ================== //
    function setupEventListeners() {
        setupDropdown();
        setupScannerInput();

        // Scan QR Code Button
        scanQrBtn.addEventListener('click', () => {
            showModal(qrScannerModal);
            startQRScanner();
        });

        // Close QR Scanner Button
        closeQrScanner.addEventListener('click', () => {
            closeModal(qrScannerModal);
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrVideo.srcObject = null;
                qrStream = null;
            }
        });

        // Close Book Details Button
        closeBookDetails.addEventListener('click', closeBookDetailsContainer);
        closeReturnDetails.addEventListener('click', closeBookDetailsContainer);

        // Close Student Modal Button
        closeStudentModal.addEventListener('click', () => {
            closeModal(studentIdModal);
        });

        // Find Book Button
        findBookBtn.addEventListener('click', findBook);

        // Search Results Click Handler
        searchResults.addEventListener('click', handleSearchResultClick);

        // Document Click Handler (to hide search results)
        document.addEventListener('click', hideSearchResultsOnClickOutside);

        // Student ID Input Handler
        studentId.addEventListener('input', handleStudentIdInput);

        // Borrow Button
        borrowBtn.addEventListener('click', borrowBook);

        // Return Button
        returnBtn.addEventListener('click', returnBook);

        // Confirm Borrow Button
        confirmBorrow.addEventListener('click', confirmBorrowBook);

        // Window Resize Handler
        window.addEventListener('resize', handleWindowResize);
    }

    function findBook() {
        const accession = accessionInput.value.trim();
        const searchTerm = bookSearch.value.trim().toLowerCase();

        if (accession) {
            // Normalize the accession number by removing hyphens
            const normalizedAccession = normalizeId(accession);

            // Find book by either original accession or normalized version
            const book = bookDatabase.find(b =>
                b.accession === accession || normalizeId(b.accession) === normalizedAccession
            );

            if (book) {
                currentBook = book;
                showBookDetailsContainer(book);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Book Not Found',
                    text: 'No book found with that accession number',
                    confirmButtonColor: '#800000'
                });
            }
        } else if (searchTerm) {
            const results = bookDatabase.filter(book =>
                (book.title.toLowerCase().includes(searchTerm) ||
                    book.author.toLowerCase().includes(searchTerm))
            );

            if (results.length === 1) {
                currentBook = results[0];
                showBookDetailsContainer(results[0]);
            } else if (results.length > 1) {
                showSearchResults(results);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'No Books Found',
                    text: 'No books match your search',
                    confirmButtonColor: '#800000'
                });
            }
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Missing Information',
                text: 'Please enter either an accession number or search term',
                confirmButtonColor: '#800000'
            });
        }
    }

    function showSearchResults(results) {
        searchResults.innerHTML = results.map(book => `
            <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 last:border-0 flex items-center"
                 data-accession="${book.accession}">
                <img src="${book.image}" alt="${book.title}" class="w-10 h-14 object-cover mr-3">
                <div>
                    <div class="font-medium text-usepmaroon">${book.title}</div>
                    <div class="text-sm text-gray-600">${book.author}</div>
                    <div class="text-xs ${book.available ? 'text-green-600' : 'text-red-600'}">
                        ${book.available ? 'Available' : 'Checked Out'}
                    </div>
                </div>
            </div>
        `).join('');

        searchResults.classList.remove('hidden');
    }

    function handleSearchResultClick(e) {
        const resultItem = e.target.closest('[data-accession]');
        if (resultItem) {
            const accession = resultItem.getAttribute('data-accession');
            const book = bookDatabase.find(b => b.accession === accession);
            if (book) {
                currentBook = book;
                showBookDetailsContainer(book);
                searchResults.classList.add('hidden');
                bookSearch.value = book.title;
            }
        }
    }

    function hideSearchResultsOnClickOutside(e) {
        if (!bookSearch.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
        }
    }

    function handleStudentIdInput() {
        const id = this.value.trim();
        const normalizedId = normalizeId(id);

        if (normalizedId.length >= 5) {
            // Find borrower by either original ID or normalized version
            const borrower = borrowerDatabase.find(b =>
                b.id === id || normalizeId(b.id) === normalizedId
            );

            if (borrower) {
                currentBorrower = borrower;
                studentPic.textContent = borrower.initials;
                studentName.textContent = borrower.name;
                studentCourse.textContent = borrower.course;
                studentIdDisplay.textContent = borrower.id;
                studentInfo.classList.remove('hidden');
            } else {
                studentInfo.classList.add('hidden');
                currentBorrower = null;
            }
        } else {
            studentInfo.classList.add('hidden');
            currentBorrower = null;
        }
    }

    function borrowBook() {
        if (!currentBook) {
            Swal.fire({
                icon: 'error',
                title: 'No Book Selected',
                text: 'Please select a valid book first',
                confirmButtonColor: '#800000'
            });
            return;
        }

        if (borrowType === 'inside') {
            // For inside borrowing, just show success message
            const bookIndex = bookDatabase.findIndex(b => b.accession === currentBook.accession);
            if (bookIndex !== -1) {
                bookDatabase[bookIndex].available = false;
            }

            Swal.fire({
                icon: 'success',
                title: 'Book Borrowed!',
                text: `${currentBook.title} has been borrowed for in-library use.`,
                confirmButtonColor: '#800000'
            }).then(() => {
                closeBookDetailsContainer();
                resetForms();
            });
        } else {
            // For outside borrowing, show student ID modal
            showModal(studentIdModal);
            studentId.focus();
        }
    }

    function confirmBorrowBook() {
        if (!currentBook) {
            Swal.fire({
                icon: 'error',
                title: 'No Book Selected',
                text: 'Please select a valid book first',
                confirmButtonColor: '#800000'
            });
            return;
        }

        if (!currentBorrower) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Student ID',
                text: 'Please enter a valid student ID',
                confirmButtonColor: '#800000'
            });
            return;
        }

        // Calculate due date based on borrow type
        const today = new Date();
        const dueDate = new Date();
        dueDate.setDate(today.getDate() + (borrowType === 'inside' ? 7 : 14));

        // Mark book as unavailable in the database
        const bookIndex = bookDatabase.findIndex(b => b.accession === currentBook.accession);
        if (bookIndex !== -1) {
            bookDatabase[bookIndex].available = false;
        }

        Swal.fire({
            icon: 'success',
            title: 'Book Borrowed!',
            html: `
                <div class="text-left">
                    <p><strong>Book:</strong> ${currentBook.title}</p>
                    <p><strong>Borrower:</strong> ${currentBorrower.name}</p>
                    <p><strong>Due Date:</strong> ${dueDate.toLocaleDateString()}</p>
                </div>
            `,
            confirmButtonColor: '#800000'
        }).then(() => {
            closeModal(studentIdModal);
            closeBookDetailsContainer();
            resetForms();
        });
    }

    function returnBook() {
        if (!currentBook) {
            Swal.fire({
                icon: 'error',
                title: 'No Book Selected',
                text: 'Please select a valid book first',
                confirmButtonColor: '#800000'
            });
            return;
        }

        // Mark book as available in the database
        const bookIndex = bookDatabase.findIndex(b => b.accession === currentBook.accession);
        if (bookIndex !== -1) {
            bookDatabase[bookIndex].available = true;
        }

        Swal.fire({
            icon: 'success',
            title: 'Book Returned!',
            text: `${currentBook.title} has been successfully returned.`,
            confirmButtonColor: '#800000'
        }).then(() => {
            closeBookDetailsContainer();
            resetForms();
        });
    }

    function handleWindowResize() {
        if (window.innerWidth <= 1024) {
            containerWrapper.style.maxWidth = '';
        } else if (secondContainer.classList.contains('show') || secondContainerReturning.classList.contains('show')) {
            containerWrapper.style.maxWidth = '1400px';
        }
    }

    // Clean up when page is closed
    window.addEventListener('beforeunload', () => {
        if (qrStream) qrStream.getTracks().forEach(track => track.stop());
    });
</script>
</body>
</html>